---
phase: 01-room-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - data/src/main/java/com/wenubey/data/repository/AuthRepositoryImpl.kt
  - data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt
  - app/src/main/java/com/wenubey/wenucommerce/core/connectivity/ConnectivityViewModel.kt
  - app/src/main/java/com/wenubey/wenucommerce/core/connectivity/OfflineConnectivityBanner.kt
  - app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
  - app/src/main/java/com/wenubey/wenucommerce/di/DataModule.kt
  - app/src/main/java/com/wenubey/wenucommerce/di/ViewmodelModule.kt
  - app/src/main/res/values/strings.xml
autonomous: true
requirements:
  - SYNC-05
  - SYNC-06

must_haves:
  truths:
    - "App displays a yellow/amber connectivity banner at the top when the device is offline"
    - "Banner slides in from the top when going offline and slides out when connectivity returns"
    - "Banner includes a no-wifi icon and 'No internet connection' text"
    - "Banner overlays content — no layout shift occurs when it appears or disappears"
    - "Banner appears on every screen (global overlay, not per-screen)"
    - "Banner appears correctly on cold launch in airplane mode (initial state emitted)"
    - "AuthRepositoryImpl caches User in Room for offline profile reads"
    - "Auth user state observation works offline — shows cached user data from Room"
  artifacts:
    - path: "data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt"
      provides: "Network state Flow wrapping ConnectivityManager.NetworkCallback"
      contains: "registerDefaultNetworkCallback"
    - path: "app/src/main/java/com/wenubey/wenucommerce/core/connectivity/ConnectivityViewModel.kt"
      provides: "ViewModel exposing isOnline StateFlow for UI consumption"
      contains: "ConnectivityObserver"
    - path: "app/src/main/java/com/wenubey/wenucommerce/core/connectivity/OfflineConnectivityBanner.kt"
      provides: "Amber banner composable with wifi-off icon and text"
      contains: "WifiOff"
    - path: "data/src/main/java/com/wenubey/data/repository/AuthRepositoryImpl.kt"
      provides: "Room-cached auth user state"
      contains: "userDao"
  key_links:
    - from: "data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt"
      to: "ConnectivityManager"
      via: "registerDefaultNetworkCallback in callbackFlow"
      pattern: "registerDefaultNetworkCallback"
    - from: "app/src/main/java/com/wenubey/wenucommerce/core/connectivity/ConnectivityViewModel.kt"
      to: "data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt"
      via: "Constructor injection — stateIn conversion"
      pattern: "connectivityObserver\\.isOnline"
    - from: "app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt"
      to: "app/src/main/java/com/wenubey/wenucommerce/core/connectivity/OfflineConnectivityBanner.kt"
      via: "Box overlay wrapping RootNavigationGraph with AnimatedVisibility"
      pattern: "AnimatedVisibility"
    - from: "data/src/main/java/com/wenubey/data/repository/AuthRepositoryImpl.kt"
      to: "data/src/main/java/com/wenubey/data/local/dao/UserDao.kt"
      via: "Caches user on auth state changes; reads from Room for offline"
      pattern: "userDao\\.upsert"
---

<objective>
Implement ConnectivityObserver, the global offline banner UI, and migrate AuthRepositoryImpl to cache user data in Room.

Purpose: Users see a clear visual indicator when offline, completing the offline awareness surface. Auth user state is cached in Room so the app can display user profile information even without network. This plan completes the Phase 1 requirement for connectivity UI (SYNC-05) and finishes the repository migration requirement (SYNC-06).

Output: ConnectivityObserver in data module, ConnectivityViewModel + OfflineConnectivityBanner in app module, modified MainActivity with Box overlay, modified AuthRepositoryImpl with Room user caching.
</objective>

<execution_context>
@/Users/wenubey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wenubey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-room-foundation/01-RESEARCH.md
@.planning/phases/01-room-foundation/01-01-SUMMARY.md

@data/src/main/java/com/wenubey/data/repository/AuthRepositoryImpl.kt
@domain/src/main/java/com/wenubey/domain/repository/AuthRepository.kt
@domain/src/main/java/com/wenubey/domain/model/user/User.kt
@data/src/main/java/com/wenubey/data/local/dao/UserDao.kt
@data/src/main/java/com/wenubey/data/local/mapper/UserMapper.kt
@data/src/main/java/com/wenubey/data/local/entity/UserEntity.kt
@app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
@app/src/main/java/com/wenubey/wenucommerce/navigation/RootNavigationGraph.kt
@app/src/main/java/com/wenubey/wenucommerce/di/DataModule.kt
@app/src/main/java/com/wenubey/wenucommerce/di/ViewmodelModule.kt
@app/src/main/java/com/wenubey/wenucommerce/di/AppModules.kt
@app/src/main/res/values/strings.xml
</context>

<!-- NOTE: This plan and 01-02 both modify DataModule.kt and are both wave 2.
     If executing in parallel, coordinate so that the second executor reads the file
     AFTER the first has written to avoid overwriting each other's changes.
     Recommended: execute 01-02 first (adds syncModule), then 01-03 (adds connectivityModule). -->

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectivityObserver, ConnectivityViewModel, and OfflineConnectivityBanner with global wiring</name>
  <files>
    data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt
    app/src/main/java/com/wenubey/wenucommerce/core/connectivity/ConnectivityViewModel.kt
    app/src/main/java/com/wenubey/wenucommerce/core/connectivity/OfflineConnectivityBanner.kt
    app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
    app/src/main/java/com/wenubey/wenucommerce/di/DataModule.kt
    app/src/main/java/com/wenubey/wenucommerce/di/ViewmodelModule.kt
    app/src/main/res/values/strings.xml
  </files>
  <action>
    **Step 1: Create ConnectivityObserver.kt** in `data/src/main/java/com/wenubey/data/connectivity/`.
    - Package: `com.wenubey.data.connectivity`
    - Class `ConnectivityObserver(private val context: Context)`
    - Property `val isOnline: Flow<Boolean>` backed by `callbackFlow`:
      1. Get `ConnectivityManager` from `context.getSystemService(Context.CONNECTIVITY_SERVICE)`.
      2. **Emit initial state BEFORE registering callback** (critical for airplane-mode launch):
         ```kotlin
         val initialOnline = connectivityManager.activeNetwork?.let { network ->
             connectivityManager.getNetworkCapabilities(network)
                 ?.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) == true
         } ?: false
         trySend(initialOnline)
         ```
      3. Register `NetworkCallback` with `onAvailable` -> `trySend(true)`, `onLost` -> `trySend(false)`, `onCapabilitiesChanged` -> check `NET_CAPABILITY_INTERNET` and trySend.
      4. `connectivityManager.registerDefaultNetworkCallback(callback)`
      5. `awaitClose { connectivityManager.unregisterNetworkCallback(callback) }`
    - Apply `.distinctUntilChanged()` to the flow.
    - Imports: `android.content.Context`, `android.net.ConnectivityManager`, `android.net.Network`, `android.net.NetworkCapabilities`, `kotlinx.coroutines.channels.awaitClose`, `kotlinx.coroutines.flow.*`.

    **Step 2: Register ConnectivityObserver in Koin.**
    In `DataModule.kt`, add to a new `val connectivityModule = module { single { ConnectivityObserver(get()) } }` or add to an existing module. If creating a new module, register it in `AppModules.kt`.

    **Step 3: Create ConnectivityViewModel.kt** in `app/src/main/java/com/wenubey/wenucommerce/core/connectivity/`.
    - Package: `com.wenubey.wenucommerce.core.connectivity`
    - Class `ConnectivityViewModel(connectivityObserver: ConnectivityObserver) : ViewModel()`
    - Property `val isOnline: StateFlow<Boolean>` = `connectivityObserver.isOnline.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), true)` — default to `true` (assume online until proven otherwise, prevents flash on startup).
    - Register in `ViewmodelModule.kt`: `viewModelOf(::ConnectivityViewModel)`.

    **Step 4: Create OfflineConnectivityBanner.kt** in `app/src/main/java/com/wenubey/wenucommerce/core/connectivity/`.
    - Package: `com.wenubey.wenucommerce.core.connectivity`
    - `@Composable fun OfflineConnectivityBanner(modifier: Modifier = Modifier)`:
      ```kotlin
      Surface(
          modifier = modifier
              .fillMaxWidth()
              .statusBarsPadding(),
          color = Color(0xFFFFC107),  // Amber — per user decision: "Warning yellow/amber"
          shadowElevation = 4.dp,
      ) {
          Row(
              modifier = Modifier
                  .fillMaxWidth()
                  .padding(horizontal = 16.dp, vertical = 10.dp),
              verticalAlignment = Alignment.CenterVertically,
              horizontalArrangement = Arrangement.spacedBy(8.dp),
          ) {
              Icon(
                  imageVector = Icons.Default.WifiOff, // Per user decision: "no-wifi icon"
                  contentDescription = null,
                  tint = Color.White,
              )
              Text(
                  text = stringResource(R.string.no_internet_connection), // Per user decision: "No internet connection" text
                  color = Color.White,
                  style = MaterialTheme.typography.bodyMedium.copy(fontWeight = FontWeight.Medium),
              )
          }
      }
      ```
    - Imports: `androidx.compose.foundation.layout.*`, `androidx.compose.material.icons.Icons`, `androidx.compose.material.icons.filled.WifiOff`, `androidx.compose.material3.*`, `androidx.compose.ui.*`, `androidx.compose.ui.graphics.Color`, `androidx.compose.ui.res.stringResource`, `androidx.compose.ui.text.font.FontWeight`, `androidx.compose.ui.unit.dp`.

    **Step 5: Add string resource.**
    In `app/src/main/res/values/strings.xml`, add:
    `<string name="no_internet_connection">No internet connection</string>`

    **Step 6: Wire the banner into MainActivity.**
    Modify `MainActivity.kt` `setContent` block. Replace the current `Surface` wrapping with a `Box` overlay pattern:

    ```kotlin
    setContent {
        KoinContext {
            WenuCommerceTheme {
                navController = rememberNavController()
                val startDestination by viewModel.startDestination.collectAsStateWithLifecycle()
                val isInitialized by viewModel.isInitialized.collectAsStateWithLifecycle()

                // Connectivity banner
                val connectivityVm: ConnectivityViewModel = koinViewModel()
                val isOnline by connectivityVm.isOnline.collectAsStateWithLifecycle()

                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    Box(modifier = Modifier.fillMaxSize()) {
                        if (isInitialized) {
                            RootNavigationGraph(
                                navController = navController,
                                startDestination = startDestination
                            )
                        }

                        // Global connectivity banner overlay — per user decision:
                        // "Top banner, visible on every screen", "Overlays on top of content (no layout shift)"
                        // "Animates in (slide down) and out (slide up)"
                        // "Auto-dismisses immediately when connectivity returns"
                        AnimatedVisibility(
                            visible = !isOnline,
                            modifier = Modifier.align(Alignment.TopCenter),
                            enter = slideInVertically(initialOffsetY = { -it }),
                            exit = slideOutVertically(targetOffsetY = { -it }),
                        ) {
                            OfflineConnectivityBanner()
                        }
                    }
                }
            }
        }
    }
    ```

    Imports to add to MainActivity:
    - `androidx.compose.animation.AnimatedVisibility`
    - `androidx.compose.animation.slideInVertically`
    - `androidx.compose.animation.slideOutVertically`
    - `androidx.compose.foundation.layout.Box`
    - `androidx.compose.ui.Alignment`
    - `com.wenubey.wenucommerce.core.connectivity.ConnectivityViewModel`
    - `com.wenubey.wenucommerce.core.connectivity.OfflineConnectivityBanner`
    - `org.koin.compose.viewmodel.koinViewModel` (or `org.koin.androidx.compose.koinViewModel` depending on Koin version — check existing imports in ViewModels for the correct one)
  </action>
  <verify>
    `./gradlew assembleDebug` succeeds.
    Grep for `registerDefaultNetworkCallback` in `ConnectivityObserver.kt` — confirms system callback is registered.
    Grep for `AnimatedVisibility` in `MainActivity.kt` — confirms banner is wired.
    Grep for `WifiOff` in `OfflineConnectivityBanner.kt` — confirms icon is present.
    Grep for `no_internet_connection` in `strings.xml` — confirms string resource exists.
  </verify>
  <done>
    ConnectivityObserver emits network state (including initial state on launch). ConnectivityViewModel exposes isOnline StateFlow. OfflineConnectivityBanner renders amber banner with wifi-off icon and "No internet connection" text. MainActivity wraps navigation graph in Box with AnimatedVisibility overlay for the banner. Banner slides in/out, overlays content without layout shift, appears on every screen, and auto-dismisses on reconnect.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate AuthRepositoryImpl to cache User in Room</name>
  <files>
    data/src/main/java/com/wenubey/data/repository/AuthRepositoryImpl.kt
    app/src/main/java/com/wenubey/wenucommerce/di/DataModule.kt
  </files>
  <action>
    **Step 1: Read AuthRepositoryImpl** to understand the current implementation pattern (Firestore listener maintaining `_currentUser: MutableStateFlow<User?>`).

    **Step 2: Add `private val userDao: UserDao` to AuthRepositoryImpl constructor parameters.** Koin will inject it (already registered in databaseModule from plan 01-01).

    **Step 3: Modify user state management to use Room as read cache.**

    The existing `currentUser: StateFlow<User?>` pattern should remain (ViewModels still observe it), but its source should be enriched with Room:

    - On **auth state change** (when Firestore user document is fetched and `_currentUser` is updated), also persist to Room: `userDao.upsert(user.toEntity())`.
    - On **app startup** (before Firestore listener fires), check Room for cached user: in `init` block or wherever the Firestore listener is set up, launch a coroutine that reads `userDao.getCurrentUser()?.toDomain()` and sets `_currentUser.value` if the Firestore listener hasn't fired yet. This provides immediate user data for offline cold starts.
    - On **logout**, clear Room user cache: `userDao.clearAll()`.
    - On **deleteAccount**, clear Room user cache: `userDao.clearAll()`.
    - On **setCurrentUserAfterOnboarding(user)**, also persist: `userDao.upsert(user.toEntity())`.
    - On **refreshCurrentUser()**, also persist the refreshed user: `userDao.upsert(user.toEntity())`.

    Import `toDomain()` and `toEntity()` from `com.wenubey.data.local.mapper.UserMapper`.
    Import `com.wenubey.data.local.dao.UserDao`.

    **Step 4: Verify DataModule.kt Koin wiring.**
    The `repositoryModule` already has `singleOf(::AuthRepositoryImpl).bind<AuthRepository>()`. Since `AuthRepositoryImpl` now takes `UserDao` in its constructor, Koin needs to resolve it. `UserDao` is already provided by `databaseModule` (from plan 01-01). Verify `databaseModule` appears BEFORE `repositoryModule` in `appModules` list (it should, from plan 01-01). If not, reorder.

    **Important:** Do NOT change the `AuthRepository` domain interface. The `currentUser: StateFlow<User?>` contract stays the same. Room is an implementation detail inside `AuthRepositoryImpl`.
  </action>
  <verify>
    `./gradlew assembleDebug` succeeds — AuthRepositoryImpl compiles with UserDao dependency.
    Grep for `userDao` in `AuthRepositoryImpl.kt` — confirms Room caching is in place.
    Grep for `userDao.upsert` in `AuthRepositoryImpl.kt` — confirms user is persisted to Room on state changes.
    Grep for `userDao.clearAll` in `AuthRepositoryImpl.kt` — confirms Room is cleared on logout and account deletion.
  </verify>
  <done>
    AuthRepositoryImpl caches User in Room on every state change. On cold start, Room provides cached user data before Firestore listener fires. On logout and account deletion, Room user cache is cleared. The AuthRepository interface is unchanged — this is an internal implementation improvement. The app works offline with cached user profile data.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew assembleDebug` completes without errors.
2. Toggle airplane mode on device/emulator — amber banner slides in from the top showing wifi-off icon and "No internet connection" text.
3. Turn airplane mode off — banner slides out immediately, no "back online" message (per user decision).
4. Launch app in airplane mode from cold start — banner appears immediately (initial state emitted correctly).
5. Banner appears on all screens (customer browse, seller products, admin dashboard) without layout shift.
6. Grep for `userDao` in `AuthRepositoryImpl.kt` confirms Room user caching.
7. Grep for `callbackFlow` in `AuthRepositoryImpl.kt` — Firestore user listener still present (auth needs real-time user state for role changes), but now also caches to Room.
</verification>

<success_criteria>
- ConnectivityObserver emits initial state + ongoing changes via callbackFlow
- Global amber banner with wifi-off icon, "No internet connection" text, slide animation
- Banner overlays content at top, no layout shift, visible on every screen
- Auto-dismisses when connectivity returns (no "back online" message)
- AuthRepositoryImpl caches User in Room on auth state changes
- Room user cache cleared on logout and account deletion
- Offline cold start shows cached user data from Room
- Full project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-room-foundation/01-03-SUMMARY.md`
</output>
