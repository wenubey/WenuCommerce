---
phase: 01-room-foundation
plan: 04
type: execute
wave: 3
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - app/src/main/java/com/wenubey/wenucommerce/core/components/EmptyNetworkState.kt
  - app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerProductCard.kt
  - app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerCategoryChip.kt
  - app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeState.kt
  - app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeAction.kt
  - app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeViewModel.kt
  - app/src/main/java/com/wenubey/wenucommerce/customer/CustomerHomeScreen.kt
  - app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
  - app/src/main/res/values/strings.xml
autonomous: true
requirements:
  - SYNC-05
  - SYNC-06

must_haves:
  truths:
    - "First launch with no network shows a friendly empty state with illustration, 'Connect to the internet to get started' text, and retry button"
    - "Retry button triggers a re-sync attempt via SyncManager.manualSync()"
    - "Shimmer/skeleton placeholders appear on first launch (empty Room) mimicking product card and category chip layout"
    - "Shimmer appears during pull-to-refresh on CustomerHomeScreen"
    - "Pull-to-refresh on CustomerHomeScreen triggers SyncManager.manualSync()"
    - "On sync failure, a brief snackbar 'Sync failed — showing cached data' is shown"
    - "Snackbar is driven by SyncManager.syncEvents SharedFlow"
  artifacts:
    - path: "app/src/main/java/com/wenubey/wenucommerce/core/components/EmptyNetworkState.kt"
      provides: "Empty state composable for first launch with no network"
      contains: "EmptyNetworkState"
    - path: "app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerProductCard.kt"
      provides: "Shimmer skeleton placeholder mimicking product card layout"
      contains: "ShimmerProductCard"
    - path: "app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerCategoryChip.kt"
      provides: "Shimmer skeleton placeholder mimicking category chip layout"
      contains: "ShimmerCategoryChip"
  key_links:
    - from: "app/src/main/java/com/wenubey/wenucommerce/customer/CustomerHomeScreen.kt"
      to: "app/src/main/java/com/wenubey/wenucommerce/core/components/EmptyNetworkState.kt"
      via: "Shown when Room is empty AND connectivity is offline"
      pattern: "EmptyNetworkState"
    - from: "app/src/main/java/com/wenubey/wenucommerce/customer/CustomerHomeScreen.kt"
      to: "app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerProductCard.kt"
      via: "Shown when isLoading is true (first launch or pull-to-refresh)"
      pattern: "ShimmerProductCard"
    - from: "app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeViewModel.kt"
      to: "data/src/main/java/com/wenubey/data/local/SyncManager.kt"
      via: "Calls manualSync() on pull-to-refresh action"
      pattern: "syncManager\\.manualSync"
    - from: "app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt"
      to: "data/src/main/java/com/wenubey/data/local/SyncManager.kt"
      via: "Collects syncEvents SharedFlow and shows Snackbar on SyncFailed"
      pattern: "syncEvents"
---

<objective>
Implement the loading experience and empty-state UI for the offline-first foundation: shimmer/skeleton placeholders, pull-to-refresh, first-launch empty state, and sync failure snackbar.

Purpose: Addresses three locked user decisions that require UI components on top of the Room-first infrastructure built in plans 01-02 and 01-03: (1) first launch with no network shows a friendly empty state, (2) shimmer/skeleton placeholders on loading, (3) sync failure surfaces a snackbar.

Output: EmptyNetworkState composable, ShimmerProductCard and ShimmerCategoryChip composables, pull-to-refresh wiring on CustomerHomeScreen, sync failure snackbar in MainActivity.
</objective>

<execution_context>
@/Users/wenubey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wenubey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-room-foundation/01-01-SUMMARY.md
@.planning/phases/01-room-foundation/01-02-SUMMARY.md
@.planning/phases/01-room-foundation/01-03-SUMMARY.md

@app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeState.kt
@app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeAction.kt
@app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeViewModel.kt
@app/src/main/java/com/wenubey/wenucommerce/customer/CustomerHomeScreen.kt
@app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
@data/src/main/java/com/wenubey/data/local/SyncManager.kt
@data/src/main/java/com/wenubey/data/connectivity/ConnectivityObserver.kt
@app/src/main/java/com/wenubey/wenucommerce/core/connectivity/ConnectivityViewModel.kt
@app/src/main/java/com/wenubey/wenucommerce/di/ViewmodelModule.kt
@app/src/main/res/values/strings.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmptyNetworkState and shimmer skeleton composables</name>
  <files>
    app/src/main/java/com/wenubey/wenucommerce/core/components/EmptyNetworkState.kt
    app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerProductCard.kt
    app/src/main/java/com/wenubey/wenucommerce/core/components/ShimmerCategoryChip.kt
    app/src/main/res/values/strings.xml
  </files>
  <action>
    **Step 1: Create EmptyNetworkState.kt** in `app/src/main/java/com/wenubey/wenucommerce/core/components/`.
    - Package: `com.wenubey.wenucommerce.core.components`
    - `@Composable fun EmptyNetworkState(onRetry: () -> Unit, modifier: Modifier = Modifier)`:
      - A centered Column filling the available space.
      - A large wifi-off icon (64.dp or similar) using `Icons.Outlined.WifiOff` or `Icons.Outlined.CloudOff` as the friendly illustration. Use `tint = MaterialTheme.colorScheme.onSurfaceVariant.copy(alpha = 0.6f)` for a soft, non-alarming look.
      - 16.dp spacer.
      - Text: `stringResource(R.string.empty_network_title)` with `MaterialTheme.typography.titleMedium`, centered.
      - 8.dp spacer.
      - Text: `stringResource(R.string.empty_network_subtitle)` with `MaterialTheme.typography.bodyMedium`, centered, `onSurfaceVariant` color.
      - 24.dp spacer.
      - `OutlinedButton(onClick = onRetry)` with text `stringResource(R.string.retry)`.
    - This composable is shown when Room data is empty AND the device is offline (per locked decision: "First launch with no network: empty state with friendly illustration + 'Connect to the internet to get started' + retry button").

    **Step 2: Add string resources** to `strings.xml`:
    ```xml
    <string name="empty_network_title">Connect to the internet to get started</string>
    <string name="empty_network_subtitle">We need a connection to load products and categories for the first time.</string>
    <string name="retry">Retry</string>
    <string name="sync_failed_snackbar">Sync failed — showing cached data</string>
    ```

    **Step 3: Create ShimmerProductCard.kt** in `app/src/main/java/com/wenubey/wenucommerce/core/components/`.
    - Package: `com.wenubey.wenucommerce.core.components`
    - `@Composable fun ShimmerProductCard(modifier: Modifier = Modifier)`:
      - A Card matching the visual proportions of the real product card layout.
      - Inside: a Column with shimmer-animated Box placeholders for:
        - Product image area (aspect ratio ~1:1 or matching real card, fill width, fixed height ~160.dp).
        - Title placeholder (rounded rect, ~70% width, 16.dp height, 8.dp top padding).
        - Price placeholder (rounded rect, ~40% width, 14.dp height, 4.dp top padding).
      - Use `Modifier.shimmerEffect()` — create a `Modifier.shimmerEffect()` extension:
        ```kotlin
        fun Modifier.shimmerEffect(): Modifier = composed {
            var size by remember { mutableStateOf(IntSize.Zero) }
            val transition = rememberInfiniteTransition(label = "shimmer")
            val startOffsetX by transition.animateFloat(
                initialValue = -2 * size.width.toFloat(),
                targetValue = 2 * size.width.toFloat(),
                animationSpec = infiniteRepeatable(
                    animation = tween(1000)
                ),
                label = "shimmer"
            )
            background(
                brush = Brush.linearGradient(
                    colors = listOf(
                        Color(0xFFE0E0E0),
                        Color(0xFFF5F5F5),
                        Color(0xFFE0E0E0),
                    ),
                    start = Offset(startOffsetX, 0f),
                    end = Offset(startOffsetX + size.width.toFloat(), size.height.toFloat()),
                )
            )
            .onGloballyPositioned { size = it.size }
        }
        ```
      - Place the `shimmerEffect()` extension in the same file or in a shared `ShimmerModifier.kt` file in the same package.
    - `@Composable fun ShimmerProductGrid(modifier: Modifier = Modifier)`:
      - Displays a grid of 4-6 `ShimmerProductCard` items in the same grid layout used by the real product grid (2 columns using LazyVerticalGrid or Column+Row).
      - Per locked decision: "shimmer/skeleton placeholders mimicking content layout (product cards)".

    **Step 4: Create ShimmerCategoryChip.kt** in `app/src/main/java/com/wenubey/wenucommerce/core/components/`.
    - Package: `com.wenubey.wenucommerce.core.components`
    - `@Composable fun ShimmerCategoryChip(modifier: Modifier = Modifier)`:
      - A rounded-rect placeholder (~80.dp width, ~32.dp height, rounded corners matching real category chips) with `shimmerEffect()`.
    - `@Composable fun ShimmerCategoryRow(modifier: Modifier = Modifier)`:
      - A horizontal Row/LazyRow of 4-5 `ShimmerCategoryChip` items with 8.dp spacing.
      - Per locked decision: "shimmer/skeleton placeholders mimicking content layout (category lists)".
  </action>
  <verify>
    `./gradlew :app:compileDebugKotlin` succeeds.
    Grep for `EmptyNetworkState` in the composable file — confirms it exists.
    Grep for `ShimmerProductCard` in the composable file — confirms it exists.
    Grep for `shimmerEffect` — confirms the modifier extension exists.
    Grep for `empty_network_title` in `strings.xml` — confirms string resource exists.
    Grep for `sync_failed_snackbar` in `strings.xml` — confirms string resource exists.
  </verify>
  <done>
    EmptyNetworkState composable displays a friendly illustration (wifi-off icon), "Connect to the internet to get started" text, and retry button. ShimmerProductCard and ShimmerCategoryChip provide skeleton placeholders mimicking real content layout. All string resources are in place. All files compile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire empty state, shimmer, pull-to-refresh, and sync failure snackbar into CustomerHomeScreen and MainActivity</name>
  <files>
    app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeState.kt
    app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeAction.kt
    app/src/main/java/com/wenubey/wenucommerce/customer/customer_home/CustomerHomeViewModel.kt
    app/src/main/java/com/wenubey/wenucommerce/customer/CustomerHomeScreen.kt
    app/src/main/java/com/wenubey/wenucommerce/MainActivity.kt
  </files>
  <action>
    **Step 1: Add pull-to-refresh action to CustomerHomeAction.kt.**
    Add `object OnPullToRefresh : CustomerHomeAction()` (or `data object OnPullToRefresh : CustomerHomeAction` depending on the existing sealed class/interface pattern).

    **Step 2: Add `isRefreshing` field to CustomerHomeState.kt.**
    Add `val isRefreshing: Boolean = false` to the data class. This drives the pull-to-refresh indicator and shimmer visibility during refresh.
    The existing `isLoading` field already covers initial load shimmer.

    **Step 3: Update CustomerHomeViewModel to handle pull-to-refresh.**
    - Add `private val syncManager: SyncManager` to constructor parameters (Koin injects it — already registered from plan 01-02).
    - Add `private val connectivityObserver: ConnectivityObserver` to constructor parameters (Koin injects it — already registered from plan 01-03).
    - Expose `val isOnline: StateFlow<Boolean> = connectivityObserver.isOnline.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5_000), true)`.
    - Handle `OnPullToRefresh` in the `onAction` when block:
      ```kotlin
      is CustomerHomeAction.OnPullToRefresh -> {
          viewModelScope.launch {
              _homeState.update { it.copy(isRefreshing = true) }
              try {
                  syncManager.manualSync()
              } finally {
                  _homeState.update { it.copy(isRefreshing = false) }
              }
          }
      }
      ```
    - Add a helper function `fun retrySync()` that calls `OnPullToRefresh` logic — this is what the EmptyNetworkState retry button triggers.
    - Update ViewmodelModule.kt to provide the new constructor dependencies (SyncManager and ConnectivityObserver are already in Koin from plans 01-02 and 01-03).

    **Step 4: Wire CustomerHomeScreen with empty state, shimmer, and pull-to-refresh.**
    Modify CustomerHomeScreen.kt:

    - Import `EmptyNetworkState`, `ShimmerProductGrid`, `ShimmerCategoryRow` from `com.wenubey.wenucommerce.core.components.*`.
    - Get `isOnline` from the ViewModel (either passed as parameter or collected in the composable).
    - Wrap the main content in `PullToRefreshBox` (Material 3 pull-to-refresh):
      ```kotlin
      PullToRefreshBox(
          isRefreshing = state.isRefreshing,
          onRefresh = { onAction(CustomerHomeAction.OnPullToRefresh) },
      ) {
          // existing content...
      }
      ```
      Per locked decision: "Pull-to-refresh available on content screens + automatic background sync".

    - Add conditional rendering logic:
      ```kotlin
      // Determine if this is a first-launch-no-data scenario
      val isEmpty = state.categories.isEmpty() && state.products.isEmpty() && !state.isLoading

      when {
          // First launch, no network, no cached data
          isEmpty && !isOnline -> {
              EmptyNetworkState(
                  onRetry = { onAction(CustomerHomeAction.OnPullToRefresh) }
              )
          }
          // Loading state (first launch empty Room, or during pull-to-refresh)
          state.isLoading || (isEmpty && isOnline) -> {
              Column {
                  ShimmerCategoryRow()
                  ShimmerProductGrid()
              }
          }
          // Normal content
          else -> {
              // existing category carousel + product grid content
          }
      }
      ```
      Per locked decisions:
      - "First launch with no network: empty state with friendly illustration + 'Connect to the internet to get started' + retry button"
      - "Shimmer appears both on first launch (empty Room) and during pull-to-refresh"

    - During pull-to-refresh, shimmer should appear on the product grid area. Use `state.isRefreshing` to conditionally show shimmer overlays OR let the PullToRefreshBox indicator handle the visual. Per locked decision, shimmer appears during pull-to-refresh, so when `state.isRefreshing && state.products.isNotEmpty()`, show shimmer over the product grid area (or replace the product grid with shimmer temporarily). The simplest approach: when `isRefreshing` is true, overlay shimmer on the product grid section using an `AnimatedVisibility` crossfade.

    **Step 5: Wire sync failure snackbar in MainActivity.**
    Modify `MainActivity.kt`:
    - Get `SyncManager` from Koin: `val syncManager: SyncManager = koinInject()` (or `org.koin.compose.koinInject`).
    - Create a `SnackbarHostState`: `val snackbarHostState = remember { SnackbarHostState() }`.
    - Wrap the existing content in a `Scaffold(snackbarHost = { SnackbarHost(snackbarHostState) })` if not already using Scaffold, or add SnackbarHost to the existing Box overlay layout.
    - Collect `syncManager.syncEvents` in a `LaunchedEffect`:
      ```kotlin
      val syncFailedMessage = stringResource(R.string.sync_failed_snackbar)
      LaunchedEffect(Unit) {
          syncManager.syncEvents.collect { event ->
              when (event) {
                  is SyncManager.SyncEvent.SyncFailed -> {
                      snackbarHostState.showSnackbar(
                          message = syncFailedMessage,
                          duration = SnackbarDuration.Short,
                      )
                  }
              }
          }
      }
      ```
    - Per locked decision: "On sync failure: brief snackbar 'Sync failed — showing cached data' then continue with cached content".
    - Import `com.wenubey.data.local.SyncManager`.
  </action>
  <verify>
    `./gradlew assembleDebug` succeeds.
    Grep for `EmptyNetworkState` in `CustomerHomeScreen.kt` — confirms empty state is wired.
    Grep for `ShimmerProductCard\|ShimmerProductGrid` in `CustomerHomeScreen.kt` — confirms shimmer is wired.
    Grep for `PullToRefreshBox` in `CustomerHomeScreen.kt` — confirms pull-to-refresh is wired.
    Grep for `syncEvents` in `MainActivity.kt` — confirms snackbar collection is wired.
    Grep for `OnPullToRefresh` in `CustomerHomeAction.kt` — confirms action exists.
    Grep for `isRefreshing` in `CustomerHomeState.kt` — confirms state field exists.
    Grep for `manualSync` in `CustomerHomeViewModel.kt` — confirms sync is triggered.
  </verify>
  <done>
    CustomerHomeScreen shows EmptyNetworkState when Room is empty AND device is offline, with retry button triggering manualSync(). Shimmer/skeleton placeholders appear on first launch (empty Room) and during pull-to-refresh. Pull-to-refresh triggers SyncManager.manualSync(). MainActivity collects SyncManager.syncEvents and shows "Sync failed — showing cached data" snackbar on sync failure. All locked user decisions for loading strategy and empty state are implemented.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew assembleDebug` completes without errors.
2. EmptyNetworkState composable exists with wifi-off icon, "Connect to the internet to get started" text, and retry button.
3. ShimmerProductCard and ShimmerCategoryChip provide skeleton placeholders matching real content proportions.
4. CustomerHomeScreen shows empty state when offline + empty Room, shimmer when loading, and normal content otherwise.
5. Pull-to-refresh on CustomerHomeScreen triggers SyncManager.manualSync().
6. Sync failure events from SyncManager surface as snackbar "Sync failed — showing cached data" in MainActivity.
7. No existing functionality is broken.
</verification>

<success_criteria>
- First launch with no network shows EmptyNetworkState with illustration + text + retry button
- Shimmer placeholders mimic product card and category chip layout
- Shimmer appears on first launch (empty Room) and during pull-to-refresh
- Pull-to-refresh calls SyncManager.manualSync()
- Sync failure emits snackbar via SyncManager.syncEvents -> MainActivity collector
- All locked user decisions for loading/empty/error states are covered
- Full project builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-room-foundation/01-04-SUMMARY.md`
</output>
